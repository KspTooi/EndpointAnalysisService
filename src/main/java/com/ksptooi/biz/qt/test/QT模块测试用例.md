# QT 模块测试用例（LocalBeanExecutionJob）

## 1. 测试目标

- 验证任务成功/失败时，任务状态在界面展示是否正确。
- 验证失败策略 `policyError` 在界面行为是否符合预期。
- 验证日志策略 `policyRcd` 在“任务记录”页面是否正确增减记录。
- 验证参数转换异常不会误显示为“异常暂停（status=2）”。
- 验证失败后任务在调度列表中的可运行性是否符合预期。

---

## 2. 状态和策略说明（按界面理解）

- 任务状态：
  - 正常（对应 `status=0`）
  - 暂停（对应 `status=1`）
  - 暂停（异常）（对应 `status=2`）
- 最近执行状态：
  - 成功（对应 `last_exec_status=0`）
  - 异常（对应 `last_exec_status=1`）
- 失败策略 `policyError`：
  - 默认：失败不自动暂停
  - 自动暂停：业务异常时自动变更为“暂停（异常）”
- 日志策略 `policyRcd`：
  - 全部：成功和失败都记录
  - 仅异常：只记录失败
  - 不记录：不产生执行记录

---

## 3. 前置准备清单（完善版）

> 本章节全部基于界面操作，不依赖 SQL。

### 3.1 环境准备

- [✅] 后端服务已启动，Web 控制台可登录。
- [✅] Quartz 调度已正常运行（可通过已有任务观察“下次执行时间”有变化）。
- [✅] 当前账号有任务管理、任务启动/暂停、任务记录查看权限。
- [✅] 浏览器清缓存后重新登录（避免旧缓存影响状态展示）。

### 3.2 测试数据准备

- [✅] 已准备 `SuccessTask`：稳定成功并返回简单结果。
- [✅] 已准备 `FailTask`：执行时稳定抛异常。
- [✅] 已准备 `DtoTask`：需要 DTO 入参，便于构造非法 JSON。
- [✅] 已准备 `StringTask`：入参为字符串，验证字符串分支。
- [✅] 建议每个用例使用独立任务名称（例如 `TC-S-01-xxx`）。

### 3.3 BEAN 准备清单

> 目标：保证每个测试 BEAN 行为稳定、可重复、可预期，避免用例因 BEAN 实现不确定而误判。

#### 3.3.1 通用实现检查

- [✅] 每个测试 BEAN 都已注册为 Spring Bean（例如 `@Component`）。
- [✅] 每个测试 BEAN 都实现 `QuickTask<T>`。
- [✅] `execute` 中不依赖外部不稳定服务（网络、第三方接口）或已做 mock。
- [✅] `execute` 内无随机失败逻辑（确保失败场景可控复现）。
- [✅] 返回结果可序列化为 JSON（成功场景）。
- [✅] 异常场景抛出明确异常（建议 `RuntimeException`，错误信息可识别）。

#### 3.3.2 SuccessTask（成功任务）

- 行为要求：
  - [✅] 每次执行都成功，不抛异常。
  - [✅] 返回固定结构结果（例如包含 `ok=true`）。
- 参数要求：
  - [✅] 可无参执行，或参数固定且稳定。
- 人工验证点：
  - [✅] 连续执行 3 次都成功。
  - [✅] 任务记录中的结果内容结构一致。

#### 3.3.3 FailTask（业务异常任务）

- 行为要求：
  - [✅] 每次执行都抛异常。
  - [✅] 异常信息固定且可识别（例如包含 `FailTask test error`）。
- 参数要求：
  - [✅] 参数是否传入不影响“必定失败”行为。
- 人工验证点：
  - [✅] 连续执行 3 次都失败。
  - [✅] 失败记录可看到异常关键信息。

#### 3.3.4 DtoTask（DTO 参数任务）

- 行为要求：
  - [✅] 合法 JSON 入参可正常执行。
  - [✅] 非法 JSON 入参稳定触发参数转换异常。
- 参数要求（建议示例）：
  - [✅] 合法：`{"name":"demo","count":1}`
  - [✅] 非法：`{"name":}`
- 人工验证点：
  - [✅] 合法参数时执行成功。
  - [✅] 非法参数时失败路径稳定触发。

#### 3.3.5 StringTask（字符串参数任务）

- 行为要求：
  - [✅] 入参按字符串接收，不进行 DTO 反序列化。
  - [✅] 对输入字符串返回可见回显或固定成功结果。
- 参数要求（建议示例）：
  - [✅] `"hello"`
  - [✅] `"中文-特殊字符-123"`
- 人工验证点：
  - [✅] 两组字符串参数均可成功执行。
  - [✅] 任务记录中可确认字符串分支已生效。

### 3.4 页面观察位确认

- [✅] 在任务列表页可看到：任务状态、上次执行状态、上次开始/结束时间。
- [✅] 在任务记录页可按任务筛选并看到：开始/结束时间、耗时、执行结果、状态。
- [✅] 在任务列表页可直接观察任务是否继续调度（下次执行时间是否持续刷新）。

### 3.5 执行规则约定

- [✅] 每次只执行一个用例，完成后再执行下一个。
- [✅] 执行前记录“任务记录条数”，执行后对比变化。
- [✅] 出现偶发失败时，先重跑一次；若仍不一致，再判定失败。
- [✅] 每个用例至少观察 1 次完整调度周期。

---

## 4. 用例列表（界面验收版）

## 4.1 成功路径

### TC-S-01 成功执行 + 全部记录

- 前置：
  - `target=SuccessTask`
  - `policyError=0`
  - `policyRcd=0`
  - 参数合法
- 步骤：
  1. 在任务管理页创建并启动任务。
  2. 等待任务执行一次完成。
  3. 查看任务列表和任务记录页。
- 预期：
  - 任务状态为“正常”
  - 上次执行状态为“成功”
  - 任务记录新增 1 条成功记录
  - 任务仍会继续调度（下次执行时间持续刷新）
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-S-02 成功执行 + 仅异常记录

- 前置：
  - `target=SuccessTask`
  - `policyError=1`
  - `policyRcd=1`
- 步骤：同 TC-S-01
- 预期：
  - 任务状态为“正常”
  - 上次执行状态为“成功”
  - 不新增任务记录
  - 任务仍会继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-S-03 成功执行 + 不记录日志

- 前置：
  - `target=SuccessTask`
  - `policyError=1`
  - `policyRcd=2`
- 步骤：同 TC-S-01
- 预期：
  - 任务状态为“正常”
  - 上次执行状态为“成功”
  - 不新增任务记录
  - 任务仍会继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

---

## 4.2 业务异常路径（`handler.execute` 抛异常）

### TC-B-01 业务异常 + 默认失败策略 + 全部记录

- 前置：
  - `target=FailTask`
  - `policyError=0`
  - `policyRcd=0`
- 步骤：
  1. 创建并启动任务。
  2. 等待任务执行并失败。
  3. 查看任务列表和任务记录页。
- 预期：
  - 任务状态保持“正常”
  - 上次执行状态为“异常”
  - 任务记录新增 1 条失败记录
  - 任务仍会继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-B-02 业务异常 + 自动暂停 + 全部记录（重点）

- 前置：
  - `target=FailTask`
  - `policyError=1`
  - `policyRcd=0`
- 步骤：同 TC-B-01
- 预期：
  - 任务状态为“暂停（异常）”
  - 上次执行状态为“异常”
  - 任务记录新增 1 条失败记录
  - 任务不再继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-B-03 业务异常 + 默认失败策略 + 仅异常记录

- 前置：
  - `target=FailTask`
  - `policyError=0`
  - `policyRcd=1`
- 步骤：同 TC-B-01
- 预期：
  - 任务状态保持“正常”
  - 上次执行状态为“异常”
  - 任务记录新增 1 条失败记录
  - 任务仍会继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-B-04 业务异常 + 自动暂停 + 仅异常记录

- 前置：
  - `target=FailTask`
  - `policyError=1`
  - `policyRcd=1`
- 步骤：同 TC-B-01
- 预期：
  - 任务状态为“暂停（异常）”
  - 上次执行状态为“异常”
  - 任务记录新增 1 条失败记录
  - 任务不再继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-B-05 业务异常 + 自动暂停 + 不记录日志

- 前置：
  - `target=FailTask`
  - `policyError=1`
  - `policyRcd=2`
- 步骤：同 TC-B-01
- 预期：
  - 任务状态为“暂停（异常）”
  - 上次执行状态为“异常”
  - 任务记录不新增
  - 任务不再继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

---

## 4.3 参数转换异常路径（JSON 反序列化失败）

### TC-P-01 参数转换异常 + 自动暂停 + 全部记录（重点）

- 前置：
  - `target=DtoTask`
  - `policyError=1`
  - `policyRcd=0`
  - 参数传非法 JSON（例如：`{"name":}`）
- 步骤：
  1. 创建并启动任务。
  2. 等待任务执行失败。
  3. 查看任务列表和任务记录页。
- 预期：
  - 任务状态为“暂停”（不是“暂停（异常）”）
  - 上次执行状态为“异常”
  - 任务记录新增 1 条失败记录
  - 任务不再继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-P-02 参数转换异常 + 自动暂停 + 仅异常记录

- 前置：
  - `target=DtoTask`
  - `policyError=1`
  - `policyRcd=1`
  - 参数传非法 JSON
- 步骤：同 TC-P-01
- 预期：
  - 任务状态为“暂停”
  - 上次执行状态为“异常”
  - 任务记录新增 1 条失败记录
  - 任务不再继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-P-03 参数转换异常 + 自动暂停 + 不记录日志

- 前置：
  - `target=DtoTask`
  - `policyError=1`
  - `policyRcd=2`
  - 参数传非法 JSON
- 步骤：同 TC-P-01
- 预期：
  - 任务状态为“暂停”
  - 上次执行状态为“异常”
  - 任务记录不新增
  - 任务不再继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

---

## 4.4 目标与参数边界

### TC-E-01 本地 Bean 不存在

- 前置：
  - `target` 配置为不存在 Bean 名称
  - `policyError=1`
  - `policyRcd=0`
- 步骤：
  1. 创建并启动任务。
  2. 观察执行一次后的状态。
- 预期：
  - 任务状态为“暂停（异常）”
  - 上次执行状态为“异常”
  - 任务记录新增 1 条失败记录
  - 任务不再继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-E-02 String 泛型参数分支

- 前置：
  - `target=StringTask`
  - `params` 为 JSON 字符串（如 `"hello"`）
  - `policyError=0`
  - `policyRcd=0`
- 步骤：
  1. 创建并启动任务。
  2. 观察执行结果。
- 预期：
  - 任务状态为“正常”
  - 上次执行状态为“成功”
  - 任务记录新增 1 条成功记录
  - 任务仍会继续调度
- 实际（人工填写）：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

### TC-E-03 空参数分支

- 前置：
  - `target=DtoTask` 或支持空参任务
  - `params` 为空字符串或空白
- 步骤：
  1. 创建并启动任务。
  2. 观察执行结果。
- 预期：
  - 若业务允许空参：任务状态“正常”，上次执行状态“成功”
  - 若业务不允许空参：按异常路径处理（状态为“暂停”或“暂停（异常）”，取决于失败类型）
- 实际（人工填写）：
  - 业务是否允许空参：
  - 任务状态：
  - 上次执行状态：
  - 任务记录变化：
  - 是否持续调度：
  - 结论：通过 / 不通过

---

## 5. 回归重点清单（最小必跑）

- [ ] 业务异常 + `policyError=1`：状态必须为“暂停（异常）”。
- [ ] 参数转换异常 + `policyError=1`：状态必须为“暂停”，不能是“暂停（异常）”。
- [ ] `policyRcd=0` 且失败：任务记录必须新增失败记录。
- [ ] `policyRcd=2`：无论成功/失败都不应新增记录。
- [ ] 标记暂停后任务不得继续调度。

---

## 6. 通用测试记录模板（可复制）

```text
用例编号：
测试人：
执行时间：
任务名称：
配置：
  target=
  policyError=
  policyRcd=
  params=

预期：
  1)
  2)
  3)
  4)

实际（人工填写）：
  1)
  2)
  3)
  4)

结论：通过 / 不通过
问题描述：
截图位置（可选）：
```
